<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Events Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fab fa-github"></i> GitHub Events Dashboard</h1>
            <p class="subtitle">Real-time monitoring of repository activities</p>
            <div class="stats">
                <span id="last-updated">Last updated: --:--:--</span>
                <span class="polling-status">
                    <i class="fas fa-sync-alt"></i>
                    <span>Polling every 15 seconds</span>
                </span>
            </div>
        </header>

        <main>
            <div class="events-container">
                <div class="events-header">
                    <h2><i class="fas fa-history"></i> Recent Activities</h2>
                    <div class="filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="PUSH">Push</button>
                        <button class="filter-btn" data-filter="PULL_REQUEST">Pull Request</button>
                        <button class="filter-btn" data-filter="MERGE">Merge</button>
                    </div>
                </div>
                
                <div id="events-list" class="events-list">
                    <div class="empty-state">
                        <i class="fas fa-code-branch"></i>
                        <p>No events yet. Perform some actions in your repository!</p>
                    </div>
                </div>
            </div>
            
            <div class="info-panel">
                <h3><i class="fas fa-info-circle"></i> How It Works</h3>
                <div class="info-content">
                    <div class="info-item">
                        <div class="icon push">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="info-text">
                            <h4>Push Events</h4>
                            <p>Triggered when code is pushed to any branch</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="icon pr">
                            <i class="fas fa-code-pull-request"></i>
                        </div>
                        <div class="info-text">
                            <h4>Pull Requests</h4>
                            <p>Triggered when a new PR is created</p>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="icon merge">
                            <i class="fas fa-code-merge"></i>
                        </div>
                        <div class="info-text">
                            <h4>Merge Events</h4>
                            <p>Triggered when a PR is merged</p>
                        </div>
                    </div>
                    
                    <div class="setup-guide">
                        <h4><i class="fas fa-cogs"></i> Setup Guide</h4>
                        <ol>
                            <li>Create a repository on GitHub</li>
                            <li>Configure webhook in repository settings</li>
                            <li>Set payload URL to: <code id="webhook-url">Loading...</code></li>
                            <li>Select events: Push & Pull Request</li>
                        </ol>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>GitHub Webhook Receiver • Polling every 15 seconds • MongoDB Storage</p>
        </footer>
    </div>

    <script>
        let currentFilter = 'all';
        
        // Display current webhook URL
        document.getElementById('webhook-url').textContent = 
            window.location.origin + '/webhook';
        
        // Filter events
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                fetchEvents();
            });
        });
        
        function formatEvent(event) {
            let icon, colorClass;
            
            switch(event.action) {
                case 'PUSH':
                    icon = '<i class="fas fa-upload"></i>';
                    colorClass = 'push-event';
                    break;
                case 'PULL_REQUEST':
                    icon = '<i class="fas fa-code-pull-request"></i>';
                    colorClass = 'pr-event';
                    break;
                case 'MERGE':
                    icon = '<i class="fas fa-code-merge"></i>';
                    colorClass = 'merge-event';
                    break;
                default:
                    icon = '<i class="fas fa-code"></i>';
                    colorClass = 'default-event';
            }
            
            return `
                <div class="event-item ${colorClass}">
                    <div class="event-icon">${icon}</div>
                    <div class="event-content">
                        <p class="event-message">${event.message}</p>
                        <div class="event-meta">
                            <span class="event-author">
                                <i class="fas fa-user"></i> ${event.author}
                            </span>
                            <span class="event-time">
                                <i class="far fa-clock"></i> ${event.timestamp}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function fetchEvents() {
            fetch('/api/events')
                .then(response => response.json())
                .then(events => {
                    if (events.error) {
                        console.error('Error fetching events:', events.error);
                        return;
                    }
                    
                    const eventsList = document.getElementById('events-list');
                    
                    if (events.length === 0) {
                        eventsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-code-branch"></i>
                                <p>No events yet. Perform some actions in your repository!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Filter events if needed
                    let filteredEvents = events;
                    if (currentFilter !== 'all') {
                        filteredEvents = events.filter(e => e.action === currentFilter);
                    }
                    
                    if (filteredEvents.length === 0) {
                        eventsList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-filter"></i>
                                <p>No ${currentFilter.toLowerCase().replace('_', ' ')} events found</p>
                            </div>
                        `;
                        return;
                    }
                    
                    eventsList.innerHTML = filteredEvents.map(formatEvent).join('');
                    
                    // Update last updated time
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    document.getElementById('last-updated').textContent = 
                        `Last updated: ${timeString}`;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('events-list').innerHTML = `
                        <div class="error-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Error loading events. Please try again.</p>
                        </div>
                    `;
                });
        }
        
        // Initial fetch
        fetchEvents();
        
        // Poll every 15 seconds
        setInterval(fetchEvents, 15000);
        
        // Auto-refresh indicator
        let refreshIcon = document.querySelector('.polling-status i');
        setInterval(() => {
            refreshIcon.style.transform = 'rotate(360deg)';
            setTimeout(() => {
                refreshIcon.style.transform = 'rotate(0deg)';
            }, 500);
        }, 15000);
    </script>
</body>
</html>